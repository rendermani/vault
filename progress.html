<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="5">
    <title>Infrastructure Rebuild Progress</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        .timestamp {
            color: #718096;
            font-size: 14px;
        }
        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .phase-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .phase-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }
        .phase-card.pending::before { background: #cbd5e0; }
        .phase-card.in-progress::before { background: #fbbf24; }
        .phase-card.completed::before { background: #48bb78; }
        .phase-card.tested::before { background: #10b981; }
        .phase-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .status-badge.pending { background: #e2e8f0; color: #718096; }
        .status-badge.in-progress { background: #fef3c7; color: #f59e0b; }
        .status-badge.completed { background: #d1fae5; color: #059669; }
        .status-badge.tested { background: #a7f3d0; color: #047857; }
        .task-list {
            list-style: none;
            margin-top: 15px;
        }
        .task-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .task-item::before {
            content: '';
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }
        .task-item.pending::before { 
            background: #e2e8f0; 
            content: '‚óã';
            text-align: center;
            line-height: 20px;
            color: #718096;
        }
        .task-item.in-progress::before { 
            background: #fbbf24;
            content: '‚óë';
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .task-item.completed::before { 
            background: #48bb78;
            content: '‚úì';
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .architecture-diagram {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .diagram-svg {
            width: 100%;
            height: auto;
        }
        .agent-status {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .agent-card {
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
        }
        .agent-card.active {
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .service-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .service-card.online {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        .service-card.offline {
            background: #fee2e2;
            border: 2px solid #ef4444;
        }
        .service-url {
            font-size: 14px;
            color: #4a5568;
            margin-top: 10px;
        }
        .service-status {
            font-size: 24px;
            margin: 10px 0;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Infrastructure Rebuild Progress</h1>
            <div class="timestamp">Last updated: <span id="timestamp">Loading...</span></div>
        </header>

        <div class="progress-section">
            <h2>Overall Progress</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress" style="width: 0%">
                    <span id="progress-text">Loading...</span>
                </div>
            </div>
            <div class="agent-status" id="agent-status">
                <div class="agent-card">Loading agents...</div>
            </div>
        </div>

        <div class="architecture-diagram">
            <h2>Architecture Implementation Status</h2>
            <svg class="diagram-svg" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                <!-- Hetzner Server -->
                <rect x="50" y="50" width="700" height="300" fill="#f0f4f8" stroke="#2d3748" stroke-width="2" rx="10"/>
                <text x="400" y="80" text-anchor="middle" font-size="18" font-weight="bold">Hetzner Root Server (SSH-Only)</text>
                
                <!-- Phase 1: Bootstrap -->
                <g id="phase1">
                    <rect x="100" y="120" width="150" height="80" fill="#cbd5e0" stroke="#718096" stroke-width="2" rx="5" class="pulse"/>
                    <text x="175" y="150" text-anchor="middle" font-size="14">Phase 1: Bootstrap</text>
                    <text x="175" y="170" text-anchor="middle" font-size="12">Ansible</text>
                    <text x="175" y="190" text-anchor="middle" font-size="10">‚è≥ Pending</text>
                </g>
                
                <!-- Services -->
                <g id="consul">
                    <rect x="300" y="120" width="100" height="60" fill="#fee2e2" stroke="#ef4444" stroke-width="2" rx="5"/>
                    <text x="350" y="145" text-anchor="middle" font-size="14">Consul</text>
                    <text x="350" y="165" text-anchor="middle" font-size="10">‚ùå Offline</text>
                </g>
                
                <g id="nomad">
                    <rect x="420" y="120" width="100" height="60" fill="#fee2e2" stroke="#ef4444" stroke-width="2" rx="5"/>
                    <text x="470" y="145" text-anchor="middle" font-size="14">Nomad</text>
                    <text x="470" y="165" text-anchor="middle" font-size="10">‚ùå Offline</text>
                </g>
                
                <g id="vault">
                    <rect x="540" y="120" width="100" height="60" fill="#fee2e2" stroke="#ef4444" stroke-width="2" rx="5"/>
                    <text x="590" y="145" text-anchor="middle" font-size="14">Vault</text>
                    <text x="590" y="165" text-anchor="middle" font-size="10">‚ùå Offline</text>
                </g>
                
                <!-- Phase 2: Configuration -->
                <g id="phase2">
                    <rect x="100" y="220" width="150" height="80" fill="#cbd5e0" stroke="#718096" stroke-width="2" rx="5"/>
                    <text x="175" y="250" text-anchor="middle" font-size="14">Phase 2: Configure</text>
                    <text x="175" y="270" text-anchor="middle" font-size="12">Terraform</text>
                    <text x="175" y="290" text-anchor="middle" font-size="10">‚è≥ Pending</text>
                </g>
                
                <!-- Traefik -->
                <g id="traefik">
                    <rect x="420" y="220" width="220" height="60" fill="#fee2e2" stroke="#ef4444" stroke-width="2" rx="5"/>
                    <text x="530" y="245" text-anchor="middle" font-size="14">Traefik + SSL</text>
                    <text x="530" y="265" text-anchor="middle" font-size="10">‚ùå Offline</text>
                </g>
            </svg>
        </div>

        <div class="grid" id="phases-grid">
            <div class="phase-card">
                <div class="status-badge">Loading phases...</div>
                <h3 class="phase-title">Loading...</h3>
                <ul class="task-list">
                    <li class="task-item">Loading tasks...</li>
                </ul>
            </div>
        </div>

        <div class="progress-section">
            <h2>Service Endpoints Status</h2>
            <div class="services-grid" id="services-grid">
                <div class="service-card">
                    <h3>Loading...</h3>
                    <div class="service-status">‚è≥</div>
                    <div class="service-url">Loading...</div>
                    <div>Status: Loading...</div>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h2>Recent Activities</h2>
            <ul id="recent-activities" style="list-style: none; padding: 0;">
                <li style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: #718096; font-size: 12px;">Loading...</span> - 
                    <span>Loading recent activities...</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        async function loadProgress() {
            try {
                // Use nginx server URL if opened as file:// 
                const baseUrl = window.location.protocol === 'file:' ? 'http://localhost:8090' : '';
                const response = await fetch(baseUrl + '/progress.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Loaded progress data:', data);
                
                // Update timestamp
                document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString();
                
                // Update overall progress
                const progressFill = document.getElementById('overall-progress');
                const progressText = document.getElementById('progress-text');
                progressFill.style.width = data.overall_progress + '%';
                progressText.textContent = `${data.overall_progress}% - ${data.status || data.current_phase}`;
                
                // Update agent status
                const agentStatus = document.getElementById('agent-status');
                if (data.active_agents && data.active_agents.length > 0) {
                    agentStatus.innerHTML = data.active_agents.map(agent => 
                        `<div class="agent-card active">${agent}</div>`
                    ).join('');
                } else {
                    // Fallback if no active_agents array
                    const agentText = data.agents ? `${data.agents.active}/${data.agents.total} Active` : 'Loading agents...';
                    agentStatus.innerHTML = `<div class="agent-card active">${agentText}</div>`;
                }
                
                // Update phase cards
                const phasesGrid = document.getElementById('phases-grid');
                if (data.phases && data.phases.length > 0) {
                    phasesGrid.innerHTML = data.phases.map(phase => {
                        const progressBar = phase.progress > 0 ? `
                            <div class="progress-bar" style="margin: 10px 0; height: 20px;">
                                <div class="progress-fill" style="width: ${phase.progress}%; height: 100%; font-size: 12px;">
                                    ${phase.progress}%
                                </div>
                            </div>
                        ` : '';
                        
                        return `
                            <div class="phase-card ${phase.status}">
                                <div class="status-badge ${phase.status}">${phase.status.replace('-', ' ')}</div>
                                <h3 class="phase-title">${phase.name}</h3>
                                ${progressBar}
                                <ul class="task-list">
                                    ${phase.tasks ? phase.tasks.map(task => 
                                        `<li class="task-item ${task.status}">${task.name}</li>`
                                    ).join('') : '<li class="task-item">No tasks</li>'}
                                </ul>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update services
                const servicesGrid = document.getElementById('services-grid');
                if (data.services && data.services.length > 0) {
                    servicesGrid.innerHTML = data.services.map(service => `
                        <div class="service-card ${service.status === 'online' ? 'online' : 'offline'}">
                            <h3>${service.name}</h3>
                            <div class="service-status">${service.status === 'online' ? '‚úÖ' : '‚ùå'}</div>
                            <div class="service-url"><a href="${service.url}" target="_blank">${service.url}</a></div>
                            <div>SSL: ${service.ssl ? '‚úÖ Valid' : '‚ùå Invalid'}</div>
                            <div>Status: ${service.status.toUpperCase()}</div>
                        </div>
                    `).join('');
                }
                
                // Update recent activities
                const activitiesList = document.getElementById('recent-activities');
                if (data.recent_activities && data.recent_activities.length > 0) {
                    activitiesList.innerHTML = data.recent_activities.slice(0, 10).map(activity => `
                        <li style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: #718096; font-size: 12px; font-weight: bold;">${activity.time}</span> - 
                            <span>${activity.message}</span>
                        </li>
                    `).join('');
                }
                
                // Update page title with progress
                document.title = `Infrastructure Progress ${data.overall_progress}% - ${data.current_phase}`;
                
                console.log('Progress updated successfully');
                
            } catch (error) {
                console.error('Failed to load progress:', error);
                // Show error in UI
                document.getElementById('timestamp').textContent = 'Error loading data - ' + new Date().toLocaleString();
                document.getElementById('progress-text').textContent = 'Error loading progress';
            }
        }
        
        // Load immediately and then every 5 seconds
        console.log('Starting progress monitoring...');
        loadProgress();
        setInterval(loadProgress, 5000);
        
        // Add connection status indicator
        window.addEventListener('online', () => {
            console.log('Connection restored');
            loadProgress();
        });
        
        window.addEventListener('offline', () => {
            console.log('Connection lost');
        });
    </script>
</body>
</html>